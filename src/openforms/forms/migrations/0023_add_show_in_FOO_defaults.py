# Generated by Django 3.2.13 on 2022-05-09 10:21

from django.db import migrations

from openforms.formio.rendering.constants import RenderConfigurationOptions
from openforms.formio.utils import iter_components

defaults = {
    RenderConfigurationOptions.show_in_summary: True,
    RenderConfigurationOptions.show_in_pdf: True,
}


def update_configuration(component: dict) -> bool:
    key = RenderConfigurationOptions.show_in_confirmation_email
    if key not in component:
        return False

    modified = False
    for option, default_value in defaults.items():
        # skip if it's defined already
        if option in component:
            continue

        component[option] = default_value
        modified = True

    return modified


def add_missing_show_in_FOO_options(apps, _):
    FormDefinition = apps.get_model("forms", "FormDefinition")
    for form_def in FormDefinition.objects.all():
        if not form_def.configuration:
            continue

        is_modified = False
        for component in iter_components(form_def.configuration, recursive=True):
            is_modified = update_configuration(component)

        if is_modified:
            form_def.save(update_fields=["configuration"])


class Migration(migrations.Migration):

    dependencies = [
        ("forms", "0022_formsexport"),
    ]

    operations = [
        migrations.RunPython(
            add_missing_show_in_FOO_options, migrations.RunPython.noop
        ),
    ]
